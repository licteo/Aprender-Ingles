<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenador de Vocabulario</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configurar fuente Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Aplicar la fuente Inter como fuente principal */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para el feedback (mensaje de correcto/incorrecto) */
        #feedback.correct {
            color: #16a34a; /* text-green-600 */
        }
        #feedback.incorrect {
            color: #dc2626; /* text-red-600 */
        }
        /* Transiciones para el modal */
        .modal-transition {
            transition: all 0.3s ease-in-out;
        }
        
        /* FIX CLAVE PARA MÓVILES: Asegurar que el contenido del modal sea scrollable */
        #add-word-modal {
            /* Usar overflow-y-auto para permitir el scroll si el contenido es más alto que la pantalla */
            overflow-y: auto; 
            /* Asegurar un padding generoso arriba y abajo para que el contenido no toque los bordes */
            padding-top: 2rem;
            padding-bottom: 2rem;
            /* Usar position: fixed para evitar que la app principal haga scroll junto con el modal */
            position: fixed;
        }

        /* FIX: Permitir que el contenido del modal ocupe toda la altura disponible */
        #modal-content {
            margin-top: auto;
            margin-bottom: auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Contenedor principal de la aplicación (tarjeta + botón de agregar) -->
    <main class="w-full max-w-lg">
        
        <!-- ID del Usuario / Mensaje de Estado -->
        <!-- NOTA: Se ha movido la lógica de error a esta sección para evitar el texto flotante -->
        <div id="user-id-display" class="text-xs text-center mb-2">
            <span class="font-bold text-gray-600">ID de Usuario:</span> Cargando...
        </div>
        
        <!-- Contenedor principal de la tarjeta de estudio -->
        <div class="bg-white w-full rounded-2xl shadow-2xl overflow-hidden transition-all duration-500 ease-in-out">
            
            <!-- 1. Imagen (Imaginación / Visual) -->
            <img id="word-image" src="https://placehold.co/600x300/EBF4FF/708090?text=Cargando..." alt="Representación visual de la palabra" class="w-full h-56 object-cover">

            <div class="p-6 md:p-8">
                
                <!-- 2. Palabra, Pronunciación y Sonido -->
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <!-- La Palabra -->
                        <h1 id="word-display" class="text-4xl md:text-5xl font-bold text-gray-900">Palabra</h1>
                        <!-- Pronunciación Fonética -->
                        <p id="word-pronunciation" class="text-xl text-gray-500 italic">/prəˌnʌnsiˈeɪʃən/</p>
                    </div>
                    <!-- Botón de Sonido -->
                    <button id="audio-btn" title="Escuchar pronunciación" class="p-3 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 hover:scale-110 transition-all duration-200 active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path>
                        </svg>
                    </button>
                </div>

                <!-- 3. Significado -->
                <div class="mb-6">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-1">Significado</h2>
                    <p id="word-meaning" class="text-lg text-gray-700">El significado de la palabra aparecerá aquí.</p>
                </div>

                <!-- 4. Narración (Frase de Ejemplo) -->
                <div class="mb-8">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Narración (Ejemplo)</h2>
                        <!-- Botón para escuchar la narración/ejemplo -->
                        <button id="example-audio-btn" title="Escuchar narración" class="p-2 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 hover:scale-110 transition-all duration-200 active:scale-95">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path>
                            </svg>
                        </button>
                    </div>
                    <blockquote id="word-example" class="border-l-4 border-blue-200 pl-4 italic text-gray-600 text-lg">
                        Una frase de ejemplo usando la palabra.
                    </blockquote>
                </div>

                <!-- Botones de Gestión (Editar y Eliminar) -->
                <div class="flex justify-end gap-3 mb-6 border-b pb-4">
                    <button id="edit-word-btn" title="Editar Palabra Actual" class="py-2 px-4 bg-yellow-100 text-yellow-700 rounded-lg font-medium hover:bg-yellow-200 transition-colors flex items-center gap-1 active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.646 7.05a1 1 0 00-.204.148l-.515.292a1 1 0 00-.54.842v4.881a1 1 0 00.928.928h4.882a1 1 0 00.841-.54l.292-.515a1 1 0 00.148-.204l1.494-1.494c.338-.338.358-.848.04-.972l-4.662-1.47a1 1 0 00-.773.774l-1.47 4.662c-.124.318-.634.298-.972-.04l-1.494-1.494z" /></svg>
                        Editar
                    </button>
                    <button id="delete-word-btn" title="Eliminar Palabra Actual" class="py-2 px-4 bg-red-100 text-red-600 rounded-lg font-medium hover:bg-red-200 transition-colors flex items-center gap-1 active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                        Eliminar
                    </button>
                </div>


                <!-- 5. Escritura (Práctica de Spelling) -->
                <div class="bg-gray-50 p-5 rounded-lg">
                    <label for="spelling-input" class="block text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Practicar Escritura</label>
                    <input type="text" id="spelling-input" placeholder="Escribe la palabra en inglés..." class="w-full p-3 border border-gray-300 rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="check-btn" class="w-full mt-3 bg-blue-600 text-white p-3 rounded-lg font-semibold text-lg hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">Comprobar</button>
                    <!-- Mensaje de feedback -->
                    <p id="feedback" class="text-center h-6 mt-2 text-lg font-medium"></p>
                </div>

                <!-- 6. Botones de Navegación -->
                <div class="flex justify-between mt-8">
                    <button id="prev-btn" class="py-2 px-5 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors disabled:opacity-50" disabled>Anterior</button>
                    <button id="next-btn" class="py-2 px-5 bg-gray-200 text-gray-800 rounded-lg font-medium hover:bg-gray-300 transition-colors disabled:opacity-50" disabled>Siguiente</button>
                </div>
            </div>
        </div>

        <!-- Botón para ABRIR el modal de agregar palabra -->
        <div class="mt-6 text-center">
            <button id="open-modal-btn" class="w-full py-3 px-5 bg-green-600 text-white rounded-xl font-semibold hover:bg-green-700 transition-colors shadow-lg active:scale-95 disabled:bg-gray-400 disabled:text-gray-200" title="Agregar Nueva Palabra">
                + Agregar Nueva Palabra
            </button>
            <!-- Nuevo span para el mensaje de advertencia bajo el botón -->
            <span id="db-warning" class="mt-2 block text-sm font-medium text-red-600 hidden">
                (Funcionalidad CRUD deshabilitada)
            </span>
        </div>

    </main>

    <!-- El Modal para Agregar/Editar Palabra (oculto por defecto) -->
    <!-- Se ajustan las clases para el FIX de scroll: p-4 es esencial en móviles. -->
    <div id="add-word-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <!-- Contenido del modal (el card) -->
        <div class="bg-white w-full max-w-md p-6 rounded-2xl shadow-xl transform modal-transition scale-95 opacity-0" id="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-5 text-gray-900">Agregar Nueva Palabra</h2>
            
            <form id="word-form">
                <div class="space-y-4">
                    <div>
                        <label for="word-input" class="block text-sm font-medium text-gray-700">Palabra (en inglés) <span class="text-red-500">*</span></label>
                        <input type="text" id="word-input" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="pronunciation-input" class="block text-sm font-medium text-gray-700">Pronunciación (ej. /ˈæpəl/)</label>
                        <input type="text" id="pronunciation-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label for="meaning-input" class="block text-sm font-medium text-gray-700">Significado (en español) <span class="text-red-500">*</span></label>
                        <input type="text" id="meaning-input" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="border p-4 rounded-lg bg-blue-50/50">
                        <label class="block text-sm font-semibold text-gray-800 mb-2">Imagen (URL o Subir Archivo)</label>
                        <p class="text-xs text-gray-500 mb-3">Si estás editando y subes un archivo, sobrescribirá la imagen actual.</p>

                        <div>
                            <label for="image-url-input" class="block text-sm font-medium text-gray-700">1. URL de la Imagen</label>
                            <input type="url" id="image-url-input" class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://images.unsplash.com/...">
                        </div>

                        <div class="my-4 border-t border-gray-200 pt-4">
                            <label for="image-file-input" class="block text-sm font-medium text-gray-700">2. Subir desde el dispositivo</label>
                            <input type="file" id="image-file-input" accept="image/*" class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                    </div>
                    
                    <div>
                        <label for="example-input" class="block text-sm font-medium text-gray-700">Narración (frase de ejemplo) <span class="text-red-500">*</span></label>
                        <input type="text" id="example-input" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <!-- Mensaje de error para imagen -->
                <p id="image-error-message" class="text-red-500 text-sm mt-3 hidden">Por favor, proporciona la URL de una imagen o sube un archivo.</p>


                <!-- Botones del Modal -->
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" id="cancel-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors font-medium">Cancelar</button>
                    <button type="submit" id="submit-word-btn" class="py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">Guardar Palabra</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal de confirmación de eliminación (Alternativa a confirm()) -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-sm shadow-xl">
            <h3 class="text-xl font-bold mb-4 text-red-600">Confirmar Eliminación</h3>
            <p class="text-gray-700 mb-6">¿Estás seguro de que quieres eliminar la palabra "<span id="word-to-delete" class="font-semibold"></span>"? Esta acción no se puede deshacer.</p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancelar
                </button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                    Eliminar
                </button>
            </div>
        </div>
    </div>


    <!-- Script de Firebase y lógica de la aplicación -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, addDoc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer el nivel de registro para depuración
        setLogLevel('Debug');

        // --- Variables Globales (MANDATORIAS) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Verificar si la configuración tiene al menos un projectId o API key para considerarla válida.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const isFirebaseConfigValid = firebaseConfig && (firebaseConfig.projectId || firebaseConfig.apiKey);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let words = [];
        let currentWordIndex = 0;
        let isAuthReady = false;
        let isFirestoreEnabled = false; // Nueva bandera para controlar si se usa Firestore
        let currentEditingDocId = null; // Almacena el ID del documento que se está editando


        // --- Base de Datos de Palabras por Defecto ---
        const defaultWords = [
            {
                id: 'default-1', // Añadir ID para simulación
                word: "Apple",
                pronunciation: "/ˈæpəl/",
                meaning: "Una fruta redonda con piel roja o verde y pulpa blanca y crujiente.",
                imageUrl: "https://images.unsplash.com/photo-1567306226416-28f0efdc88ce?ixlib=rb-4.0.3&q=80&w=600&auto=format&fit=crop&crop=edges",
                example: "She eats an apple every day for breakfast.",
                timestamp: Date.now()
            },
            {
                id: 'default-2', // Añadir ID para simulación
                word: "Book",
                pronunciation: "/bʊk/",
                meaning: "Un conjunto de hojas de papel impresas o en blanco, unidas por un lado dentro de una cubierta.",
                imageUrl: "https://images.unsplash.com/photo-1541963463532-d68292c34b19?ixlib=rb-4.0.3&q=80&w=600&auto=format&fit=crop&crop=edges",
                example: "I am reading a fascinating book about history.",
                timestamp: Date.now() + 1
            },
            {
                id: 'default-3', // Añadir ID para simulación
                word: "Hello",
                pronunciation: "/həˈloʊ/",
                meaning: "Una expresión utilizada como saludo al encontrarse con alguien.",
                imageUrl: "https://images.unsplash.com/photo-1554774853-7f03caeb52b0?ixlib=rb-4.0.3&q=80&w=600&auto=format&fit=crop&crop=edges",
                example: "He smiled and said, 'Hello, how are you?'",
                timestamp: Date.now() + 2
            }
        ];
        
        // --- Selectores del DOM ---
        const wordDisplay = document.getElementById('word-display');
        const wordPronunciation = document.getElementById('word-pronunciation');
        const wordImage = document.getElementById('word-image');
        const wordMeaning = document.getElementById('word-meaning');
        const wordExample = document.getElementById('word-example');
        const audioBtn = document.getElementById('audio-btn');
        const spellingInput = document.getElementById('spelling-input');
        const checkBtn = document.getElementById('check-btn');
        const feedback = document.getElementById('feedback');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const exampleAudioBtn = document.getElementById('example-audio-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const dbWarning = document.getElementById('db-warning'); // Nuevo selector
        
        // Botones de CRUD
        const editWordBtn = document.getElementById('edit-word-btn');
        const deleteWordBtn = document.getElementById('delete-word-btn');
        const openModalBtn = document.getElementById('open-modal-btn'); 

        // Selectores del Modal Add/Edit
        const addWordModal = document.getElementById('add-word-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const cancelBtn = document.getElementById('cancel-btn');
        const wordForm = document.getElementById('word-form');
        const submitWordBtn = document.getElementById('submit-word-btn');

        // Inputs del Modal
        const wordInput = document.getElementById('word-input');
        const pronunciationInput = document.getElementById('pronunciation-input');
        const meaningInput = document.getElementById('meaning-input');
        const exampleInput = document.getElementById('example-input');
        const imageUrlInput = document.getElementById('image-url-input');
        const imageFileInput = document.getElementById('image-file-input');
        const imageErrorMessage = document.getElementById('image-error-message');
        
        // Modal de confirmación de eliminación
        const confirmModal = document.getElementById('confirm-modal');
        const wordToDeleteSpan = document.getElementById('word-to-delete');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        
        // --- Setup de Firebase ---
        
        async function initializeFirebase() {
            if (!isFirebaseConfigValid) {
                console.warn("ADVERTENCIA: Configuración de Firebase inválida. Se cargan datos por defecto sin funcionalidad de guardado.");
                
                // Mostrar la advertencia de que CRUD está deshabilitado
                userIdDisplay.innerHTML = `<span class="font-bold text-red-600">ERROR:</span> Base de datos no inicializada.`;
                dbWarning.classList.remove('hidden');

                words = defaultWords.map(w => ({...w})); // Copia para asegurar mutabilidad en la simulación
                isFirestoreEnabled = false; // Deshabilitar CRUD
                displayWord(currentWordIndex);
                
                // Deshabilitar botones de CRUD si Firestore no está habilitado
                editWordBtn.disabled = true;
                deleteWordBtn.disabled = true;
                openModalBtn.disabled = true;
                return false;
            }

            isFirestoreEnabled = true;
            dbWarning.classList.add('hidden'); // Ocultar la advertencia si la DB está habilitada
            
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Manejar el estado de autenticación
                return new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userIdDisplay.innerHTML = `<span class="font-bold text-gray-700">ID de Usuario:</span> ${userId}`;
                            isAuthReady = true;
                            setupFirestoreListener(); // Iniciar listener una vez autenticado
                            resolve(true);
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                            // onAuthStateChanged se activará de nuevo.
                        }
                    });
                });

            } catch (error) {
                // Este catch ahora captura el error si la configuración es válida PERO falla la inicialización (ej. reglas de seguridad)
                console.error("Error al inicializar Firebase o al autenticar:", error);
                userIdDisplay.innerHTML = `<span class="font-bold text-red-600">ERROR:</span> Error crítico de autenticación.`;
                isFirestoreEnabled = false;
                dbWarning.classList.remove('hidden');
                
                // Volver al modo demo si la inicialización falla
                words = defaultWords.map(w => ({...w})); 
                displayWord(currentWordIndex);
                editWordBtn.disabled = true;
                deleteWordBtn.disabled = true;
                openModalBtn.disabled = true;
                return false;
            }
        }

        function getUserCollectionPath() {
            if (!userId) {
                return null;
            }
            return `/artifacts/${appId}/users/${userId}/vocabulary`;
        }

        // --- Lógica de Firebase (CRUD + Listener) ---
        
        /**
         * Inicializa la colección con palabras por defecto si está vacía.
         */
        async function seedDatabaseIfEmpty(snapshot) {
            if (!isFirestoreEnabled) return;
            if (snapshot.empty) {
                const collectionRef = collection(db, getUserCollectionPath());
                console.log("Base de datos vacía, añadiendo palabras por defecto...");
                for (const word of defaultWords) {
                    // Quitamos el ID de simulación antes de guardarlo en Firestore
                    const { id, ...data } = word; 
                    await addDoc(collectionRef, data);
                }
            }
        }

        /**
         * Escucha en tiempo real los cambios en la colección.
         */
        function setupFirestoreListener() {
            if (!isAuthReady || !userId || !isFirestoreEnabled) return;

            const collectionPath = getUserCollectionPath();
            if (!collectionPath) return;

            // Ordenar por el timestamp para mantener el orden
            const q = query(collection(db, collectionPath), orderBy("timestamp", "asc"));

            onSnapshot(q, async (snapshot) => {
                // Si ya teníamos palabras y ahora no hay, o si es la carga inicial y está vacío.
                const needsSeeding = words.length === 0 && snapshot.empty;

                // Mapear los documentos a nuestro array de palabras
                words = [];
                snapshot.forEach((doc) => {
                    words.push({ id: doc.id, ...doc.data() });
                });
                
                // Si es la primera carga y está vacío, inicializa con datos por defecto
                if (needsSeeding) {
                    // No es necesario llamar a displayWord aquí, el onSnapshot se activará de nuevo después del seeding.
                    await seedDatabaseIfEmpty(snapshot);
                    return; 
                }
                
                // Asegurar que el índice actual sea válido
                if (currentWordIndex >= words.length && words.length > 0) {
                    currentWordIndex = words.length - 1;
                } else if (words.length === 0) {
                    currentWordIndex = 0;
                }
                
                displayWord(currentWordIndex);
            }, (error) => {
                console.error("Error al escuchar los datos de Firestore:", error);
                // Si hay un error, volvemos a mostrar el modo de error
                isFirestoreEnabled = false;
                words = defaultWords.map(w => ({...w}));
                displayWord(0); // Mostrar la primera palabra de demo
            });
        }
        
        /**
         * Realiza la operación de Agregar o Editar en Firestore.
         */
        async function upsertWord(wordData) {
            if (!isFirestoreEnabled) return; // No hacer nada si Firestore está deshabilitado
            const collectionPath = getUserCollectionPath();
            if (!collectionPath) return;

            try {
                if (currentEditingDocId) {
                    // EDITAR: Actualiza el documento existente
                    const docRef = doc(db, collectionPath, currentEditingDocId);
                    await updateDoc(docRef, wordData);
                    console.log(`Palabra con ID ${currentEditingDocId} actualizada.`);
                    feedback.textContent = 'Palabra actualizada con éxito.';
                } else {
                    // AGREGAR: Crea un nuevo documento
                    wordData.timestamp = Date.now(); // Añadir timestamp para ordenar
                    await addDoc(collection(db, collectionPath), wordData);
                    console.log("Nueva palabra agregada.");
                    feedback.textContent = 'Palabra agregada con éxito.';
                }
                feedback.className = 'correct';
                setTimeout(() => { feedback.textContent = ''; feedback.className = ''; }, 2000);
            } catch (error) {
                console.error("Error al guardar la palabra:", error);
                feedback.textContent = 'Error al guardar. Revisa la consola.';
                feedback.className = 'incorrect';
            }
        }

        /**
         * Elimina un documento de Firestore.
         */
        async function deleteWordFromFirestore(docId) {
            if (!isFirestoreEnabled) return; // No hacer nada si Firestore está deshabilitado
            const collectionPath = getUserCollectionPath();
            if (!collectionPath) return;

            try {
                const docRef = doc(db, collectionPath, docId);
                await deleteDoc(docRef);
                
                // Mueve el índice después de la eliminación para que el listener se actualice
                if (currentWordIndex > 0) {
                    currentWordIndex--; 
                }
                console.log(`Palabra con ID ${docId} eliminada.`);
            } catch (error) {
                console.error("Error al eliminar la palabra:", error);
                // No es necesario actualizar la UI aquí, el onSnapshot lo hará.
            } finally {
                hideDeleteConfirmation();
            }
        }

        // --- Funciones de Utilidad y UI ---
        
        /**
         * Convierte un archivo de imagen (File object) en una cadena Base64 (data URL).
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        /**
         * Muestra la palabra actual en la interfaz
         */
        function displayWord(index) {
            // Verificar si estamos en modo de demostración (sin Firestore habilitado)
            if (!isFirestoreEnabled) {
                // Modo DEMO / Error de DB
                wordDisplay.textContent = "¡Bienvenido!";
                wordPronunciation.textContent = "(Modo de Demostración)";
                wordMeaning.textContent = "Estás viendo datos locales. La funcionalidad de guardado (CRUD) está deshabilitada.";
                wordExample.textContent = "Revisa la consola para detalles del error de conexión.";
                wordImage.src = "https://placehold.co/600x300/FEE2E2/DC2626?text=DB+DESHABILITADA";
                wordImage.alt = "Pantalla de bienvenida o error";
                
                // Deshabilitar CRUD
                editWordBtn.disabled = true;
                deleteWordBtn.disabled = true;
                openModalBtn.disabled = true;
                dbWarning.classList.remove('hidden');
                
                // Si aún así hay palabras de la lista de demostración, las mostramos
                if (words.length > 0) {
                    const wordData = words[index];
                    wordDisplay.textContent = wordData.word;
                    wordPronunciation.textContent = wordData.pronunciation;
                    wordMeaning.textContent = wordData.meaning;
                    wordExample.textContent = wordData.example;
                    wordImage.src = wordData.imageUrl;
                    wordImage.alt = `Imagen de ${wordData.word}`;
                    
                    // Asegurar que el ID de usuario muestre el estado de error
                    userIdDisplay.innerHTML = `<span class="font-bold text-red-600">ERROR:</span> Base de datos no inicializada.`;
                }

                // Deshabilitar navegación (siempre que la lista de words sea la de demo)
                nextBtn.disabled = true;
                prevBtn.disabled = true;
                return;
            }
            
            // Modo Firestore Habilitado
            dbWarning.classList.add('hidden');

            if (words.length === 0) {
                // Estado inicial cuando Firestore está vacío pero funciona
                wordDisplay.textContent = "¡Bienvenido!";
                wordPronunciation.textContent = "Añade tu primera palabra";
                wordMeaning.textContent = "Haz clic en 'Agregar Nueva Palabra' para empezar a estudiar.";
                wordExample.textContent = "La aplicación utiliza Firestore para guardar tus datos.";
                wordImage.src = "https://placehold.co/600x300/6366F1/FFFFFF?text=VOCABULARIO+APP";
                wordImage.alt = "Pantalla de bienvenida";
                
                editWordBtn.disabled = true;
                deleteWordBtn.disabled = true;
                openModalBtn.disabled = false;
                nextBtn.disabled = true;
                prevBtn.disabled = true;
                return;
            }


            // Modo Firestore Habilitado CON Palabras
            const wordData = words[index];
            wordDisplay.textContent = wordData.word;
            wordPronunciation.textContent = wordData.pronunciation;
            wordMeaning.textContent = wordData.meaning;
            wordExample.textContent = wordData.example;
            
            // Habilitar/Deshabilitar botones de navegación (solo si hay más de 1 palabra)
            nextBtn.disabled = words.length <= 1;
            prevBtn.disabled = words.length <= 1;
            
            // Habilitar CRUD
            editWordBtn.disabled = false;
            deleteWordBtn.disabled = false;
            openModalBtn.disabled = false;

            // Actualizar imagen
            const imageUrl = wordData.imageUrl || `https://placehold.co/600x300/F59E0B/FFFFFF?text=${wordData.word}`; // Fallback con la palabra
            wordImage.src = imageUrl;
            wordImage.alt = `Imagen de ${wordData.word}`;
            
            // Limpiar campos de práctica
            spellingInput.value = '';
            // No borrar feedback si es un mensaje de éxito/error de guardado
            if (feedback.className !== 'correct' && feedback.className !== 'incorrect') {
                 feedback.textContent = '';
                 feedback.className = '';
            }
        }

        /**
         * Usa la API de Síntesis de Voz para decir un texto
         */
        function speak(text) {
            if (!text || text.trim() === "") return;
            window.speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        /**
         * Muestra la siguiente palabra
         */
        function nextWord() {
            if (words.length === 0) return;
            currentWordIndex = (currentWordIndex + 1) % words.length; 
            displayWord(currentWordIndex);
        }

        /**
         * Muestra la palabra anterior
         */
        function prevWord() {
            if (words.length === 0) return;
            currentWordIndex = (currentWordIndex - 1 + words.length) % words.length; 
            displayWord(currentWordIndex);
        }

        /**
         * Comprueba la ortografía (spelling)
         */
        function checkSpelling() {
            if (words.length === 0) return;

            const userInput = spellingInput.value.trim().toLowerCase();
            const correctWord = words[currentWordIndex].word.toLowerCase();

            if (userInput === correctWord) {
                feedback.textContent = '¡Correcto! ¡Muy bien!';
                feedback.className = 'correct';
                speak('Correct! Well done!'); 
            } else {
                feedback.textContent = 'Inténtalo de nuevo.';
                feedback.className = 'incorrect';
                speak('Try again.');
            }
        }
        
        // --- Lógica del Modal Add/Edit ---

        /**
         * Abre el modal, pre-llenándolo si es para editar.
         */
        function openModal(isEdit = false) {
            if (!isFirestoreEnabled) return; // Bloquear si Firestore está deshabilitado
            
            wordForm.reset(); 
            imageErrorMessage.classList.add('hidden');
            currentEditingDocId = null;

            if (isEdit && words.length > 0) {
                // Modo Edición
                const wordData = words[currentWordIndex];
                modalTitle.textContent = "Editar Palabra";
                submitWordBtn.textContent = "Guardar Cambios";
                submitWordBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                submitWordBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                
                wordInput.value = wordData.word || '';
                pronunciationInput.value = wordData.pronunciation || '';
                meaningInput.value = wordData.meaning || '';
                exampleInput.value = wordData.example || '';
                // Solo cargar la URL si no es un Base64 (archivo local), aunque se permite Base64 en el input
                imageUrlInput.value = (wordData.imageUrl && !wordData.imageUrl.startsWith('data:')) ? wordData.imageUrl : ''; 
                imageFileInput.value = ''; // Siempre limpiar input de archivo
                
                currentEditingDocId = wordData.id;

            } else {
                // Modo Agregar
                modalTitle.textContent = "Agregar Nueva Palabra";
                submitWordBtn.textContent = "Guardar Palabra";
                submitWordBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                submitWordBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                
            }

            addWordModal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
                wordInput.focus();
            }, 50); 
        }

        function closeModal() {
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                addWordModal.classList.add('hidden');
                wordForm.reset(); 
                currentEditingDocId = null;
            }, 200);
        }

        async function handleFormSubmit(event) {
            event.preventDefault(); 
            if (!isFirestoreEnabled) {
                closeModal();
                return;
            }
            
            imageErrorMessage.classList.add('hidden');

            const urlValue = imageUrlInput.value.trim();
            const file = imageFileInput.files[0];
            let finalImageUrl = '';

            // 1. Validar imagen o usar la imagen existente en modo edición
            if (!urlValue && !file) {
                if (currentEditingDocId) {
                    // En edición, si no hay nuevo input, se mantiene la imagen existente
                    finalImageUrl = words[currentWordIndex].imageUrl;
                } else {
                    // En modo agregar, se requiere imagen o URL
                    imageErrorMessage.textContent = 'Por favor, proporciona la URL de una imagen o sube un archivo.';
                    imageErrorMessage.classList.remove('hidden');
                    return; 
                }
            }

            // 2. Procesar la nueva imagen (async)
            if (file) {
                try {
                    // Convertir el archivo local a Base64
                    finalImageUrl = await fileToBase64(file);
                } catch (error) {
                    console.error("Error al leer el archivo de imagen:", error);
                    imageErrorMessage.textContent = 'Error al procesar el archivo. Intenta con otra imagen o URL.';
                    imageErrorMessage.classList.remove('hidden');
                    return;
                }
            } else if (urlValue) {
                finalImageUrl = urlValue;
            }

            // 3. Crear el objeto de la palabra
            const wordData = {
                word: wordInput.value.trim(),
                pronunciation: pronunciationInput.value.trim() || `/${wordInput.value.toLowerCase()}/`,
                meaning: meaningInput.value.trim(),
                imageUrl: finalImageUrl,
                example: exampleInput.value.trim()
            };

            // 4. Añadir/Guardar y cerrar modal
            await upsertWord(wordData);
            closeModal();
        }
        
        // --- Lógica del Modal de Eliminación ---

        function showDeleteConfirmation(word) {
            if (words.length === 0 || !isFirestoreEnabled) return;
            
            currentEditingDocId = words[currentWordIndex].id; // Reusar la variable para el ID a eliminar
            wordToDeleteSpan.textContent = word;
            confirmModal.classList.remove('hidden');
            confirmModal.classList.add('flex');
        }

        function hideDeleteConfirmation() {
            currentEditingDocId = null;
            wordToDeleteSpan.textContent = '';
            confirmModal.classList.add('hidden');
            confirmModal.classList.remove('flex');
        }

        // --- Event Listeners ---

        // Inicializar Firebase y comenzar a escuchar los datos
        initializeFirebase();

        // Navegación
        nextBtn.addEventListener('click', nextWord);
        prevBtn.addEventListener('click', prevWord);
        
        // Audio
        audioBtn.addEventListener('click', () => {
            if (words.length > 0) speak(words[currentWordIndex].word);
        });
        exampleAudioBtn.addEventListener('click', () => {
            if (words.length > 0) speak(words[currentWordIndex].example);
        });

        // Práctica de Spelling
        checkBtn.addEventListener('click', checkSpelling);
        spellingInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                checkSpelling();
            }
        });

        // Modal Add/Edit
        openModalBtn.addEventListener('click', () => openModal(false)); // Abrir para agregar
        editWordBtn.addEventListener('click', () => {
            if (words.length > 0) openModal(true); // Abrir para editar
        }); 
        cancelBtn.addEventListener('click', closeModal);
        wordForm.addEventListener('submit', handleFormSubmit);
        
        // Cerrar modal al hacer clic en el fondo oscuro
        addWordModal.addEventListener('click', (event) => {
            // Se debe asegurar que el clic sea exactamente en el fondo, no en un elemento dentro del modalContent
            if (event.target === addWordModal) {
                closeModal();
            }
        });

        // Modal de Eliminación
        deleteWordBtn.addEventListener('click', () => {
            if (words.length > 0) {
                showDeleteConfirmation(words[currentWordIndex].word);
            }
        });
        cancelDeleteBtn.addEventListener('click', hideDeleteConfirmation);
        confirmDeleteBtn.addEventListener('click', () => {
            if (currentEditingDocId) {
                deleteWordFromFirestore(currentEditingDocId);
            }
        });
        
        // Limpieza de campos al alternar entre URL y Archivo
        imageUrlInput.addEventListener('input', () => {
            if (imageUrlInput.value.trim() !== '') {
                imageFileInput.value = '';
                imageErrorMessage.classList.add('hidden');
            }
        });

        imageFileInput.addEventListener('change', () => {
            if (imageFileInput.files.length > 0) {
                imageUrlInput.value = '';
                imageErrorMessage.classList.add('hidden');
            }
        });

        // Manejador de error para las imágenes
        wordImage.onerror = function() {
            this.src = `https://placehold.co/600x300/FEE2E2/DC2626?text=Error+al+cargar+imagen`;
            this.alt = 'Error al cargar la imagen';
        };

    </script>
</body>
</html>